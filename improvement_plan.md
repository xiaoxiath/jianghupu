# AI 叙事系统架构改进方案

本文档旨在对当前 AI 叙事系统进行评估，并提出一系列可落地的改进方案，以增强游戏的核心体验、进化玩法深度，并优化长期运营成本。

## 总体评估

当前“程序管规则，AI 管叙事”的架构设计清晰、稳健，是理想的开发起点。其优势在于**关注点分离**、**可预测性**和**易于扩展**。

然而，该架构将 AI 的能力限制在了“被动叙事”上。为了创造一个真正动态、智能的江湖，我们需要让 AI 更深入地参与到游戏世界的运作中。

## 改进路线图

我们建议分三个阶段进行迭代，以确保平稳过渡和风险可控。

---

### **第一阶段：体验优化 (短期)**

**目标**：立竿见影地提升玩家体验，解决 AI 响应延迟带来的卡顿感。

**核心方案**：**异步化 AI 调用与流式响应**

#### TODO List:

*   **后端 (`src/narrator/`)**
    *   [ ] **改造 AI 服务接口**：将 `narrate(context)` 等同步方法改造为支持流式响应的异步方法，例如返回一个 `AsyncGenerator`。
    *   [ ] **实现流式调用**：在 `src/core/ai/providers/` 中，确保对大模型 API 的调用开启了 `stream: true` 选项。
    *   [ ] **创建新的 API 端点**：设计一个新的 API 端点（例如 `POST /api/narrate/stream`），用于处理流式叙事请求。此端点将保持连接打开，并持续推送 AI 生成的文本片段。

*   **前端 (`src/ui/`)**
    *   [ ] **改造 UI 请求逻辑**：修改前端状态管理（如 Redux/Zustand），使其能够处理流式响应。
    *   [ ] **实现文本流式渲染**：更新 UI 组件，使其能够接收并逐字或逐句渲染来自后端的文本流，实现“打字机”效果。
    *   [ ] **添加加载状态**：在 AI 开始响应前，在 UI 上显示一个即时的占位符或加载动画（例如 "..."），以提供即时反馈。

---

### **第二阶段：核心进化 (中期)**

**目标**：将 AI 从“叙事者”提升为“世界参与者”，创造由 AI 驱动的动态事件和更智能的 NPC。

**核心方案**：**引入 AI 代理 (AI Agent) 驱动的 NPC**

#### TODO List:

*   **数据层 (`prisma/`)**
    *   [ ] **扩展 NPC 数据模型**：在 `NPC` 模型中增加字段，用于存储其内在状态，如 `goals` (目标), `mood` (情绪), `memories` (短期记忆)。

*   **核心 AI (`src/core/ai/`)**
    *   [ ] **设计 Agent Prompt**：创建新的提示词模板，该模板包含 NPC 的角色设定、目标、记忆和当前的游戏上下文，并要求 AI 输出结构化的决策（意图）。
    *   [ ] **定义意图模式 (Intent Schema)**：设计一套标准化的 JSON 结构来表示 NPC 的意图，例如 `{ "action": "attack", "target": "player", "reason": "insulted" }` 或 `{ "action": "move_to", "location": "tavern" }`。
    *   [ ] **创建 Agent 决策模块**：在 `src/core/ai/` 下新建 `agents/` 目录，并实现一个 `decideNextAction(npc, context)` 函数，该函数负责调用 AI 并解析返回的意图。

*   **游戏系统 (`src/systems/`)**
    *   [ ] **创建意图执行器 (Intent Executor)**：开发一个新系统，负责接收来自 AI Agent 的意图，并将其转化为具体的游戏逻辑（例如调用战斗系统、更新 NPC 位置等）。
    *   [ ] **改造游戏循环**：在主游戏循环或事件循环中，为 AI Agent 留出决策和行动的时间片。可以考虑在特定事件（如玩家进入场景、与 NPC 对话后）或按时间触发。

*   **试点与迭代**
    *   [ ] **选择试点 NPC**：选择 1-2 个核心 NPC 作为 Agent 化改造的试点对象。
    *   [ ] **评估与调优**：观察 Agent NPC 的行为是否符合预期，并持续迭代 Prompt 和决策逻辑。

---

### **第三阶段：成本与规模化 (长期)**

**目标**：在项目规模扩大后，有效控制 AI 调用成本，并保证不同场景下的响应速度和叙事质量。

**核心方案**：**分层叙事系统 (Hybrid Narrative System)**

#### TODO List:

*   **叙事器 (`src/narrator/`)**
    *   [ ] **创建叙事分发器 (Narrative Dispatcher)**：实现一个 `dispatch(context)` 函数，它根据事件的类型、重要性、频率等因素，决定将请求路由到哪个叙事层级。
    *   [ ] **实现 L0 - 模板层**：创建一个模板引擎，用于处理最高频、最简单的文本生成（如战斗伤害、拾取物品），可以存储在 `src/narrator/templates/` 中。
    *   [ ] **集成 L1 - 轻量模型**：在 `src/core/ai/providers/` 中添加对一个或多个轻量级、低成本模型的 API 调用支持。这可能是一个较小的云端模型或一个本地部署的模型。
    *   [ ] **定义分发规则**：建立一个配置文件（例如 `narrative_rules.json`），用于定义哪些事件类型或上下文关键字应该匹配到哪个叙事层级。

*   **数据与内容**
    *   [ ] **标记事件重要性**：在事件定义或游戏内容中，增加一个 `importance` 字段，以帮助分发器做出决策。

*   **监控与分析**
    *   [ ] **建立成本监控**：记录每次 AI 调用的层级、模型、Token 消耗和费用，以便进行成本分析和优化。
