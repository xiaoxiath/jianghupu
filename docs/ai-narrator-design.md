# 🤖 《江湖残卷》AI 说书人与 Prompt 工程

---

## 1. 核心目标与原则

- **目标**: 生成符合古风武侠世界观、具有代入感、且能动态适应游戏进程的叙事文本。
- **原则**:
    - **一致性 (Consistency)**: 叙事风格与世界设定保持一致。
    - **动态性 (Dynamism)**: 叙事能反映玩家状态和世界变化。
    - **引导性 (Guidance)**: 提供的选项能清晰引导玩家进行决策。
    - **高效性 (Efficiency)**: 控制 Token 消耗与生成延迟。

---

## 2. 说书人性格模板

| 性格 | 核心风格 | 关键词 | 适用场景 |
|---|---|---|---|
| **宿命** (Fatalistic) | 苍凉、厚重、强调因果 | 天意、劫数、终将 | 重大剧情转折、传承 |
| **诙谐** (Witty) | 轻松、幽默、略带调侃 | 不料、竟、偏生 | 日常探索、轻松奇遇 |
| **哲理** (Philosophical) | 引人深思、探讨人心 | 何为侠、道与魔 | 内心挣扎、人物对话 |
| **疯癫** (Maniacal) | 混乱、无序、充满呓语 | 嘿嘿、血、杀 | 心魔幻境、邪派剧情 |

---

## 3. Prompt 结构设计

### 3.1. 通用 Prompt 结构

```
# Role: 你是一位《江湖残卷》的说书人。
# Style: [说书人性格模板]
# Context:
- 世界时间: [当前时间]
- 当前地点: [地点名称], [地点描述]
- 玩家状态:
  - 姓名: [玩家姓名]
  - 境界: [玩家境界]
  - 状态: [气血/内力/心境]
  - 最近事件: [玩家上一步行动及结果]
- 世界摘要: [宏观世界发生的关键事件，如“魔教最近攻陷了华山”]

# Task:
1.  基于以上情境，用不超过 100 字的篇幅，生动地描述当前场景。
2.  提供 3-4 个供玩家选择的行动选项。选项应简洁、富于想象空间，并以数字列表格式呈现。
3.  确保你的叙述和选项符合 [说书人性格模板] 的风格。

# Output Format:
{
  "narration": "你的叙事文本...",
  "options": [
    "1. 第一个选项",
    "2. 第二个选项",
    "3. 第三个选项"
  ]
}
```

### 3.2. 特定场景 Prompt 微调 (示例)
- **战斗场景**: 增加“敌人信息”上下文，选项侧重于战术（如“猛攻”、“游走”、“暂退”）。
- **社交场景**: 增加“NPC信息”上下文，选项侧重于对话和态度（如“恭维”、“质问”、“旁敲侧击”）。

---

## 4. 输出校验与安全护栏 (Guardrails)

- **格式校验**: 必须返回合法的 JSON 结构。
- **内容审查**: 过滤不当、暴力、敏感内容。
- **长度限制**: 叙事文本和选项长度必须在设定范围内。
- **风格一致性检查**: (可选) 使用另一个 LLM 或关键词匹配来评估生成内容是否符合所选风格。

---

## 5. 成本与性能策略

- **模型选择**:
    - **本地模式**: Ollama + Phi-3/Mistral (用于高频、低成本的日常叙事)。
    - **云端模式**: OpenAI GPT-4/5 (用于低频、高质量的关键剧情)。
- **缓存机制**:
    - 对相同的 `(场景 + 玩家状态)` 输入，缓存其生成结果。
    - 定期清理冷缓存。
- **并发处理**: 使用 Worker Threads 异步调用 LLM API，避免阻塞游戏主循环。